<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Resume Building Assistant</title>
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css"
      rel="stylesheet"
    />
    <!-- Add jsPDF for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- Add docx.js for Word document generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/docx/7.8.2/docx.min.js"></script>
    <!-- Add FileSaver.js for saving files -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <style>
      .chat-container {
        height: 60vh;
        overflow-y: auto;
      }
      .typing-indicator {
        display: inline-block;
      }
      .typing-indicator span {
        height: 8px;
        width: 8px;
        float: left;
        margin: 0 1px;
        background-color: #9880ff;
        display: block;
        border-radius: 50%;
        opacity: 0.4;
      }
      .typing-indicator span:nth-of-type(1) {
        animation: 1s blink infinite 0.3333s;
      }
      .typing-indicator span:nth-of-type(2) {
        animation: 1s blink infinite 0.6666s;
      }
      .typing-indicator span:nth-of-type(3) {
        animation: 1s blink infinite 0.9999s;
      }
      @keyframes blink {
        50% {
          opacity: 1;
        }
      }
    </style>
  </head>
  <body class="bg-gray-100 min-h-screen">
    <div class="container mx-auto py-6 px-4">
      <header class="mb-8 text-center">
        <h1 class="text-3xl font-bold text-indigo-600">
          Resume Building Assistant
        </h1>
        <p class="text-gray-600 mt-2">
          Your AI-powered guide to creating a standout resume
        </p>
      </header>

      <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Main Chat Area -->
        <div class="lg:col-span-2 bg-white rounded-lg shadow-md p-5">
          <div
            id="chat-container"
            class="chat-container mb-4 p-3 border border-gray-200 rounded-lg"
          >
            <div class="flex items-start mb-4">
              <div class="flex-shrink-0 bg-indigo-500 rounded-full p-2">
                <svg
                  class="w-6 h-6 text-white"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                  xmlns="http://www.w3.org/2000/svg"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"
                  ></path>
                </svg>
              </div>
              <div class="ml-3 bg-gray-100 rounded-lg py-2 px-4 max-w-3xl">
                <p class="text-gray-700">
                  Hi! I'm your resume building assistant. I'll help you create
                  or improve your resume. Let's get started! What part of your
                  resume would you like to work on first? (e.g., personal
                  information, work experience, education, skills)
                </p>
              </div>
            </div>
            <!-- Chat messages will appear here -->
          </div>

          <div id="typing-indicator" class="ml-12 mb-4 hidden">
            <div
              class="typing-indicator bg-gray-100 rounded-lg py-2 px-4 inline-block"
            >
              <span></span>
              <span></span>
              <span></span>
            </div>
          </div>

          <div class="flex">
            <input
              type="text"
              id="user-input"
              class="flex-grow border border-gray-300 rounded-l-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500"
              placeholder="Type your message here..."
            />
            <button id="send-button" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-r-lg">
              <svg class="w-5 h-5 transform rotate-45" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
              </svg>
            </button>
          </div>
        </div>

        <!-- Side Panel -->
        <div class="bg-white rounded-lg shadow-md p-5">
          <h2 class="text-xl font-semibold text-gray-800 mb-4">
            Resume Building Tools
          </h2>

          <div class="mb-6">
            <h3 class="text-lg font-medium text-gray-700 mb-2">
              Quick Actions
            </h3>
            <button
              id="export-resume"
              class="w-full bg-green-600 hover:bg-green-700 text-white font-medium py-2 px-4 rounded mb-2"
            >
              Generate Complete Resume
            </button>
            <button
              id="clear-chat"
              class="w-full bg-red-600 hover:bg-red-700 text-white font-medium py-2 px-4 rounded"
            >
              Clear Chat
            </button>
          </div>

          <div class="mb-6">
            <h3 class="text-lg font-medium text-gray-700 mb-2">
              Resume Sections
            </h3>
            <div class="space-y-2">
              <button
                class="suggestion-btn w-full bg-indigo-100 hover:bg-indigo-200 text-indigo-800 font-medium py-2 px-4 rounded text-left"
              >
                Help with personal information
              </button>
              <button
                class="suggestion-btn w-full bg-indigo-100 hover:bg-indigo-200 text-indigo-800 font-medium py-2 px-4 rounded text-left"
              >
                Improve my work experience section
              </button>
              <button
                class="suggestion-btn w-full bg-indigo-100 hover:bg-indigo-200 text-indigo-800 font-medium py-2 px-4 rounded text-left"
              >
                Format my education details
              </button>
              <button
                class="suggestion-btn w-full bg-indigo-100 hover:bg-indigo-200 text-indigo-800 font-medium py-2 px-4 rounded text-left"
              >
                Enhance my skills section
              </button>
            </div>
          </div>

          <div>
            <h3 class="text-lg font-medium text-gray-700 mb-2">
              Common Requests
            </h3>
            <div class="space-y-2">
              <button
                class="suggestion-btn w-full bg-indigo-100 hover:bg-indigo-200 text-indigo-800 font-medium py-2 px-4 rounded text-left"
              >
                Add strong action verbs
              </button>
              <button
                class="suggestion-btn w-full bg-indigo-100 hover:bg-indigo-200 text-indigo-800 font-medium py-2 px-4 rounded text-left"
              >
                Quantify my achievements
              </button>
              <button
                class="suggestion-btn w-full bg-indigo-100 hover:bg-indigo-200 text-indigo-800 font-medium py-2 px-4 rounded text-left"
              >
                Review for ATS compatibility
              </button>
            </div>
          </div>

          <!-- Resume Storage Area -->
          <div class="mt-6 border-t pt-4">
            <h3 class="text-lg font-medium text-gray-700 mb-2">
              Your Resume Information
            </h3>
            <div id="resume-sections" class="text-sm">
              <div class="text-gray-500 italic">
                Chat with the assistant to build your resume information.
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Resume Preview Modal -->
      <div
        id="resume-modal"
        class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center"
      >
        <div
          class="bg-white rounded-lg p-8 max-w-4xl w-full max-h-screen overflow-y-auto"
        >
          <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl font-bold text-gray-800">
              Your Generated Resume
            </h2>
            <button id="close-modal" class="text-gray-500 hover:text-gray-700">
              <svg
                class="w-6 h-6"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
                xmlns="http://www.w3.org/2000/svg"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M6 18L18 6M6 6l12 12"
                ></path>
              </svg>
            </button>
          </div>
          <div id="resume-content" class="prose max-w-none">
            <!-- Resume content will be inserted here -->
          </div>
          <div class="mt-6 flex flex-wrap justify-end gap-2">
            <button
              id="copy-resume"
              class="bg-indigo-600 hover:bg-indigo-700 text-white font-medium py-2 px-4 rounded"
            >
              Copy to Clipboard
            </button>
            <button
              id="download-text"
              class="bg-green-600 hover:bg-green-700 text-white font-medium py-2 px-4 rounded"
            >
              Download as Text
            </button>
            <button
              id="download-pdf"
              class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded"
            >
              Download as PDF
            </button>
            <button
              id="download-docx"
              class="bg-purple-600 hover:bg-purple-700 text-white font-medium py-2 px-4 rounded"
            >
              Download as Word (.docx)
            </button>
          </div>
        </div>
      </div>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", function () {
        // Keep track of resume information
        const resumeInfo = {
          "Personal Information": "",
          "Work Experience": "",
          Education: "",
          Skills: "",
          "Additional Sections": "",
        };

        // Function to add a message to the chat
        function addMessage(sender, message) {
          const chatContainer = document.getElementById("chat-container");
          const messageDiv = document.createElement("div");
          messageDiv.className = "flex items-start mb-4";

          // Convert message from markdown to HTML if it's from the bot
          const formattedMessage =
            sender === "bot" ? markdownToHtml(message) : message;

          if (sender === "user") {
            messageDiv.innerHTML = `
              <div class="flex-shrink-0 bg-indigo-300 rounded-full p-2 ml-auto">
                  <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                  </svg>
              </div>
              <div class="mr-3 bg-indigo-100 rounded-lg py-2 px-4 max-w-3xl ml-auto">
                  <p class="text-gray-700">${message}</p>
              </div>
            `;
          } else {
            messageDiv.innerHTML = `
              <div class="flex-shrink-0 bg-indigo-500 rounded-full p-2">
                  <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
                  </svg>
              </div>
              <div class="ml-3 bg-gray-100 rounded-lg py-2 px-4 max-w-3xl">
                  <div class="text-gray-700">${formattedMessage}</div>
              </div>
            `;
          }

          chatContainer.appendChild(messageDiv);
          chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        // Update resume information based on conversation
        function updateResumeSection(userMessage, botResponse) {
          // Simple logic to categorize information based on keywords
          let section = "";

          const lowerUserMsg = userMessage.toLowerCase();
          if (
            lowerUserMsg.includes("name") ||
            lowerUserMsg.includes("contact") ||
            lowerUserMsg.includes("email") ||
            lowerUserMsg.includes("phone") ||
            lowerUserMsg.includes("address") ||
            lowerUserMsg.includes("personal")
          ) {
            section = "Personal Information";
          } else if (
            lowerUserMsg.includes("work") ||
            lowerUserMsg.includes("job") ||
            lowerUserMsg.includes("experience") ||
            lowerUserMsg.includes("employment") ||
            lowerUserMsg.includes("career")
          ) {
            section = "Work Experience";
          } else if (
            lowerUserMsg.includes("education") ||
            lowerUserMsg.includes("degree") ||
            lowerUserMsg.includes("school") ||
            lowerUserMsg.includes("university") ||
            lowerUserMsg.includes("college")
          ) {
            section = "Education";
          } else if (
            lowerUserMsg.includes("skill") ||
            lowerUserMsg.includes("proficiency") ||
            lowerUserMsg.includes("ability") ||
            lowerUserMsg.includes("technical") ||
            lowerUserMsg.includes("competency")
          ) {
            section = "Skills";
          } else if (
            lowerUserMsg.includes("certification") ||
            lowerUserMsg.includes("award") ||
            lowerUserMsg.includes("volunteer") ||
            lowerUserMsg.includes("language") ||
            lowerUserMsg.includes("hobby") ||
            lowerUserMsg.includes("interest") ||
            lowerUserMsg.includes("project") ||
            lowerUserMsg.includes("publication")
          ) {
            section = "Additional Sections";
          }

          // Update the section if identified
          if (section) {
            resumeInfo[section] += userMessage + "\n\n";
            updateResumeSectionsDisplay();
          }
        }

        // Update the resume sections display
        function updateResumeSectionsDisplay() {
          const container = document.getElementById("resume-sections");
          container.innerHTML = "";

          for (const [section, content] of Object.entries(resumeInfo)) {
            if (content.trim()) {
              const sectionEl = document.createElement("div");
              sectionEl.className = "mb-2";
              sectionEl.innerHTML = `
                <div class="font-medium text-indigo-600">${section}</div>
                <div class="text-gray-600 truncate">${content
                  .split("\n\n")[0]
                  .substring(0, 30)}...</div>
              `;
              container.appendChild(sectionEl);
            }
          }

          if (container.children.length === 0) {
            container.innerHTML =
              '<div class="text-gray-500 italic">Chat with the assistant to build your resume information.</div>';
          }
        }

        // Send message function
        function sendMessage() {
          const userInput = document.getElementById("user-input");
          const message = userInput.value.trim();

          if (message === "") return;

          // Add user message to chat
          addMessage("user", message);

          // Clear input
          userInput.value = "";

          // Show typing indicator
          document
            .getElementById("typing-indicator")
            .classList.remove("hidden");

          // Send to server
          fetch("/get_response", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ prompt: message }),
          })
            .then((response) => response.json())
            .then((data) => {
              // Hide typing indicator
              document
                .getElementById("typing-indicator")
                .classList.add("hidden");

              // Add bot message to chat
              if (data.response) {
                addMessage("bot", data.response);
                // Update resume information
                updateResumeSection(message, data.response);
              } else if (data.error) {
                addMessage("bot", `Error: ${data.error}`);
              }
            })
            .catch((error) => {
              document
                .getElementById("typing-indicator")
                .classList.add("hidden");
              addMessage(
                "bot",
                `Sorry, there was an error processing your request.`
              );
              console.error("Error:", error);
            });
        }

        // Event listeners
        document
          .getElementById("send-button")
          .addEventListener("click", sendMessage);
        document
          .getElementById("user-input")
          .addEventListener("keypress", function (e) {
            if (e.key === "Enter") {
              sendMessage();
            }
          });

        // Handle suggestion buttons
        document.querySelectorAll(".suggestion-btn").forEach((button) => {
          button.addEventListener("click", function () {
            document.getElementById("user-input").value = this.textContent;
            sendMessage();
          });
        });

        // Function to convert markdown to HTML
        function markdownToHtml(markdown) {
          // Handle paragraphs first
          let html = markdown
            .replace(/\n\n/g, "</p><p>")
            .replace(/\n/g, "<br>");

          // Headings
          html = html
            .replace(/^# (.*?)$/gm, "<h1>$1</h1>")
            .replace(/^## (.*?)$/gm, "<h2>$1</h2>")
            .replace(/^### (.*?)$/gm, "<h3>$1</h3>")
            .replace(/^#### (.*?)$/gm, "<h4>$1</h4>");

          // Bold and Italic
          html = html
            .replace(/\*\*(.*?)\*\*/g, "<strong>$1</strong>")
            .replace(/\*(.*?)\*/g, "<em>$1</em>")
            .replace(/__(.*?)__/g, "<strong>$1</strong>")
            .replace(/_(.*?)_/g, "<em>$1</em>");

          // Lists
          html = html
            .replace(/^\- (.*?)$/gm, "<li>$1</li>")
            .replace(/^\* (.*?)$/gm, "<li>$1</li>")
            .replace(/^\d+\. (.*?)$/gm, "<li>$1</li>");

          // Wrap lists
          html = html.replace(/<li>(.*?)<\/li>\s*<li>/g, "<li>$1</li><li>");

          // Find list segments and wrap them
          let parts = html.split(/<li>/);
          if (parts.length > 1) {
            html = parts[0];
            for (let i = 1; i < parts.length; i++) {
              if (i === 1) {
                html += "<ul><li>" + parts[i];
              } else {
                html += "<li>" + parts[i];
              }
            }
            html += "</ul>";
          }

          // Horizontal rule
          html = html.replace(/---/g, "<hr>");

          // Links
          html = html.replace(/\[(.*?)\]\((.*?)\)/g, '<a href="$2">$1</a>');

          // Code blocks - inline
          html = html.replace(/`([^`]+)`/g, "<code>$1</code>");

          // Wrap in paragraph tags if not already
          if (!html.startsWith("<p>")) {
            html = "<p>" + html;
          }
          if (!html.endsWith("</p>")) {
            html += "</p>";
          }

          // Fix any potential double paragraph wrapping
          html = html.replace(/<p><p>/g, "<p>");
          html = html.replace(/<\/p><\/p>/g, "</p>");

          return html;
        }

        // Function to strip HTML and get plain text
        function stripHtml(html) {
          const tempDiv = document.createElement("div");
          tempDiv.innerHTML = html;
          return tempDiv.textContent || tempDiv.innerText || "";
        }

        // Export resume functionality
        document
          .getElementById("export-resume")
          .addEventListener("click", function () {
            document
              .getElementById("typing-indicator")
              .classList.remove("hidden");

            fetch("/export_resume", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({ resumeInfo: resumeInfo }),
            })
              .then((response) => response.json())
              .then((data) => {
                document
                  .getElementById("typing-indicator")
                  .classList.add("hidden");

                if (data.resume) {
                  // Use the markdown conversion function
                  let htmlContent = markdownToHtml(data.resume);
                  document.getElementById("resume-content").innerHTML =
                    htmlContent;
                  document
                    .getElementById("resume-modal")
                    .classList.remove("hidden");
                } else if (data.error) {
                  addMessage("bot", `Error: ${data.error}`);
                }
              })
              .catch((error) => {
                document
                  .getElementById("typing-indicator")
                  .classList.add("hidden");
                addMessage(
                  "bot",
                  `Sorry, there was an error generating your resume.`
                );
                console.error("Error:", error);
              });
          });

        // PDF Export Functionality
        document
          .getElementById("download-pdf")
          .addEventListener("click", function () {
            try {
              const { jsPDF } = window.jspdf;
              const doc = new jsPDF({
                orientation: "portrait",
                unit: "mm",
                format: "a4",
              });

              const content = document.getElementById("resume-content");
              const plainText = stripHtml(content.innerHTML);

              // Set font and size
              doc.setFont("helvetica", "normal");
              doc.setFontSize(12);

              // Split text to fit page width
              const splitText = doc.splitTextToSize(plainText, 180);
              doc.text(splitText, 15, 15);

              // Save the PDF
              doc.save("my_resume.pdf");

              // Show success message
              const button = this;
              const originalText = button.textContent;
              button.textContent = "Downloaded!";
              setTimeout(() => {
                button.textContent = originalText;
              }, 2000);
            } catch (error) {
              console.error("PDF generation error:", error);
              alert("Error generating PDF. Please try again.");
            }
          });

        // Word Document Export Functionality
        document
          .getElementById("download-docx")
          .addEventListener("click", function () {
            try {
              const { Document, Packer, Paragraph, TextRun } = docx;
              const content = document.getElementById("resume-content");
              const plainText = stripHtml(content.innerHTML);

              // Create document
              const doc = new Document({
                sections: [
                  {
                    properties: {},
                    children: plainText
                      .split("\n")
                      .map(
                        (text) =>
                          new Paragraph({
                            children: [new TextRun(text)],
                          })
                      ),
                  },
                ],
              });

              // Generate and save document
              Packer.toBlob(doc).then((blob) => {
                saveAs(blob, "my_resume.docx");

                // Show success message
                const button = this;
                const originalText = button.textContent;
                button.textContent = "Downloaded!";
                setTimeout(() => {
                  button.textContent = originalText;
                }, 2000);
              });
            } catch (error) {
              console.error("Word document generation error:", error);
              alert("Error generating Word document. Please try again.");
            }
          });

        // Text download
        document
          .getElementById("download-text")
          .addEventListener("click", function () {
            const resumeText = stripHtml(
              document.getElementById("resume-content").innerHTML
            );
            const blob = new Blob([resumeText], { type: "text/plain" });
            saveAs(blob, "my_resume.txt");

            // Show success message
            const button = this;
            const originalText = button.textContent;
            button.textContent = "Downloaded!";
            setTimeout(() => {
              button.textContent = originalText;
            }, 2000);
          });

        // Copy resume to clipboard
        document
          .getElementById("copy-resume")
          .addEventListener("click", function () {
            const resumeText = stripHtml(
              document.getElementById("resume-content").innerHTML
            );
            navigator.clipboard
              .writeText(resumeText)
              .then(() => {
                this.textContent = "Copied!";
                setTimeout(() => {
                  this.textContent = "Copy to Clipboard";
                }, 2000);
              })
              .catch((err) => {
                console.error("Failed to copy: ", err);
              });
          });

        // Handle modal close button
        document
          .getElementById("close-modal")
          .addEventListener("click", function () {
            document.getElementById("resume-modal").classList.add("hidden");
          });

        // Clear chat
        document
          .getElementById("clear-chat")
          .addEventListener("click", function () {
            if (confirm("Are you sure you want to clear the chat?")) {
              // Clear chat container
              document.getElementById("chat-container").innerHTML = "";
              // Add initial message
              addMessage(
                "bot",
                "Hi! I'm your resume building assistant. I'll help you create or improve your resume. Let's get started! What part of your resume would you like to work on first?"
              );
            }
          });
      });
    </script>
  </body>
</html>